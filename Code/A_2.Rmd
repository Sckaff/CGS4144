---
title: "A_2"
output: html_document
date: '2022-09-21'
---

Attaching all required libraries and setting seed for reproducability
```{r}
# Attach the DESeq2 library
library(DESeq2)

# Attach the ggplot2 library for plotting
library(ggplot2)

# We will need this so we can use the pipe: %>%
library(magrittr)

# Tidyverse
library(tidyverse)

# Heat Map
library(pheatmap)

# For automatically setting the working directory path
library(rstudioapi)

set.seed(12345)
```

Get the csv into dataframes
```{r}
# Set the path of the working directory
setwd(dirname(getActiveDocumentContext()$path))
# Read the csv files to dfs
data <- read_csv("../Data/counts.csv") %>% tibble::column_to_rownames("Gene") # Set "Gene" column to index
clinical <- read_csv("../Data/conditions.csv") %>% as.data.frame(clinical)
```

Cleaning the data
```{r}
# Rename column to Condition for accessibility
clinical <- rename(clinical,c('Condition'='Primary Cytogenetic Code'))
# Explicitly change Condition to a factor so to order by normal (control):disease
clinical <- clinical %>% dplyr::mutate(
  Condition = factor(Condition, levels = c("Normal", "Disease"))
)
```

Initializing DESeq object
```{r}
ddset <- DESeqDataSetFromMatrix(
  countData = data,
  colData = clinical,
  design = ~Condition
)
```

Creating DESeq object and storing its results
```{r echo=False}
deseq_object <- DESeq(ddset)
deseq_results <- results(deseq_object)
```

Here we will use `lfcShrink()` function to obtain shrunken log fold change estimates based on negative binomial distribution.
This will add the estimates to your results table. 
Using `lfcShrink()` can help decrease noise and preserve large differences between groups (it requires that `apeglm` package be installed) [@Zhu2018].
```{r}
deseq_results <- lfcShrink(
  deseq_object, # The original DESeq2 object after running DESeq()
  coef = 2, # The log fold change coefficient used in DESeq(); the default is 2.
  res = deseq_results # The original DESeq2 results table
)
```

```{r}
head(deseq_results)
```


Cleaning the results to suit what we want
```{r}
# this is of class DESeqResults -- we want a data frame
deseq_df <- deseq_results %>%
  # make into data.frame
  as.data.frame() %>%
  # the gene names are row names -- let's make them a column for easy display
  tibble::rownames_to_column("Gene") %>%
  # add a column for significance threshold results
  dplyr::mutate(threshold = padj < 0.05) %>%
  # sort by statistic -- the highest values will be genes with
  # higher expression in RPL10 mutated samples
  dplyr::arrange(dplyr::desc(log2FoldChange))
```

```{r}
head(deseq_df)
```

[Gene expressions associated with AML found here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5807040/)
- CEBPA expression is linked to the differentiation of myeloid progenitors 
- CD74 expression is linked to antigen presentation
```{r}
png("../Plots/CEBPA-exp.png")
# Using overexpression of CEBPA as a biomarker for AML
plotCounts(ddset, gene = "CEBPA", intgroup = "Condition")
dev.off()
```
```{r}
png("../Plots/CD74-exp.png")
# Using underexpression of CD74 as a biomarker for AML
plotCounts(ddset, gene = "CD74", intgroup = "Condition")
dev.off()
```

Creating the volcano plot
```{r}
volcano_plot <- EnhancedVolcano::EnhancedVolcano(
  deseq_df,
  lab = deseq_df$Gene,
  x = "log2FoldChange",
  y = "padj",
  pCutoff = 0.01 # Loosen the cutoff since we supplied corrected p-values
)
```
```{r}
volcano_plot
```

Prettier volcano plot
```{r}
pretty_volcano_plot <- EnhancedVolcano::EnhancedVolcano(
  deseq_df,
  lab = deseq_df$Gene,
  x = "log2FoldChange",
  y = "padj",
  pCutoff = 0.01,
  pointSize = 3.0,
  legendLabels=c('Not sig.','Log2FC','p-value',
      'p-value & Log2FC'),
  title = "Gene expression differentiation in normal vs diseased sample groups"
)
```
```{r}
pretty_volcano_plot
```

Creating Heat Map

- Normalizing data
```{r}
dds_norm <- vst(ddset)
```

- Choosing genes of interest
```{r}
# Calculate the variance for each gene
variances <- apply(assay(dds_norm), 1, var)

# Determine the upper quartile variance cutoff value
upper_var <- quantile(variances, 0.9995)

# Filter the data choosing only genes whose variances are in the upper quartile
df_by_var <- data.frame(assay(dds_norm)) %>%
  dplyr::filter(variances > upper_var)
```

Not-so-good Heat Map
```{r}
heatmap <- pheatmap(
  df_by_var,
  cluster_rows = TRUE, # Cluster the rows of the heatmap (genes in this case)
  cluster_cols = TRUE, # Cluster the columns of the heatmap (samples),
  show_rownames = FALSE, # There are too many genes to clearly show the labels
  main = "Heat Map",
  colorRampPalette(c(
    "deepskyblue",
    "black",
    "yellow"
  ))(25
  ),
  scale = "row" # Scale values in the direction of genes (rows)
)
```

